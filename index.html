<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CodeMirror 打字模拟器 - 专业版</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/theme-one-dark.min.css"
    />

    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #1e1e1e;
        color: #ccc;
        font-family: "Courier New", Courier, monospace;
      }
      #editor {
        width: 100%;
        height: 90vh;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="editor"></div>

    <script type="module">
      import {
        EditorView,
        basicSetup,
      } from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@6.6.2/dist/index.min.js";
      import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.2.0/dist/index.min.js";
      import { oneDark } from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.min.js";
      import { javascript } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.2.2/dist/index.min.js";
      import { python } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@6.2.1/dist/index.min.js";
      import { html } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.2.0/dist/index.min.js";

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          fileName: params.get("code") || "example.js",
          fontSize: params.get("fontSize") || "16",
          speed: params.get("speed") || "60",
          loop: params.get("loop") || "false",
        };
      }

      const config = getQueryParams();
      config.typingSpeedMin = config.speed / 2;
      config.typingSpeedMax = config.speed;

      let editor;
      let content = "";
      let index = 0;
      let typingTimer;

      function getLanguageExtension(fileName) {
        if (fileName.endsWith(".py")) return python();
        if (fileName.endsWith(".html")) return html();
        return javascript();
      }

      function createEditor(languageExtension) {
        if (editor) {
          editor.destroy();
        }
        editor = new EditorView({
          state: EditorState.create({
            extensions: [
              basicSetup,
              oneDark,
              languageExtension,
              EditorView.editable.of(false),
            ],
          }),
          parent: document.getElementById("editor"),
        });
        editor.dom.style.fontSize = `${config.fontSize}px`;
      }

      function typeCode() {
        if (index < content.length) {
          editor.dispatch({
            changes: { from: editor.state.doc.length, insert: content[index] },
          });
          index++;
          const delay =
            Math.random() * (config.typingSpeedMax - config.typingSpeedMin) +
            config.typingSpeedMin;
          typingTimer = setTimeout(typeCode, delay);
        } else {
          if (config.loop === "true") {
            setTimeout(() => {
              editor.dispatch({
                changes: { from: 0, to: editor.state.doc.length, insert: "" },
              });
              index = 0;
              typeCode();
            }, 1000);
          }
        }
      }

      function loadCodeAndStart() {
        fetch(`/api/code?file=${config.fileName}`)
          .then((res) => res.text())
          .then((data) => {
            content = data;
            index = 0;
            createEditor(getLanguageExtension(config.fileName));
            clearTimeout(typingTimer);
            typeCode();
          })
          .catch((err) => {
            console.error("加载失败:", err);
            content = "Hello World !";
            index = 0;
            createEditor(javascript());
            typeCode();
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadCodeAndStart();
      });
    </script>
  </body>
</html>
